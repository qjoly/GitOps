apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: adguard
  namespace: argocd
spec:
  project: default
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  destination:
    server: https://kubernetes.default.svc
    namespace: adguard
  source:
    repoURL: https://charts.gabe565.com
    chart: adguard-home
    targetRevision: 0.3.25
    helm:
      values: |
        service:
          main:
            ports:
              http:
                port: 80
        env:
          TZ: "Europe/Paris"
        ingress: 
            main:
              enabled: true
              annotations:
                external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
                external-dns.alpha.kubernetes.io/hostname: "adguard-home.<path:kv/cluster#domain>"
                external-dns.alpha.kubernetes.io/target: "<path:kv/cloudflare#tunnelid>.cfargotunnel.com"
              hosts:
                - host: adguard-home.<path:kv/cluster#domain>
                  paths:
                    - path: /
        persistence:
          config:
            enabled: true
            retain: false
            mountPath: /opt/adguardhome/conf
            accessMode: ReadWriteOnce
            size: 1Gi
          data:
            enabled: true
            retain: false
            mountPath: /opt/adguardhome/work
            accessMode: ReadWriteOnce
            size: 4Gi
